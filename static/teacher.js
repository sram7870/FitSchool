/* teacher_dashboard.js — interactive frontend for teacher_dashboard.html
   - Hooks all modals, search autocomplete, pagination, messenger stubs, stats drawing
   - Placeholder fetch calls use `/api/...` endpoints (implement server-side later)
   - Author: generated by ChatGPT
*/

// Safe DOM getters
const $ = (sel, ctx=document)=> ctx.querySelector(sel);
const $$ = (sel, ctx=document)=> Array.from(ctx.querySelectorAll(sel));

// --- Application state (simple in-memory mocks; replace with server data) ---
let state = {
    classes: [],         // {id,name,desc,teacher,students,pending}
    forms: [],           // {id,title,prompt,assigned_to,due,pendingCount}
    submissions: [],     // {id,formId,student,submittedAt,text}
    threads: [],         // messenger threads
    currentPage: 1,
    pageSize: 6,
};

// --- Mock data for demo (will be replaced by server responses) ---
function seedMockData(){
    state.classes = [
        {id:101,name:'Resistance Training • 9th',desc:'Intro to strength & movement.',teacher:'You',students:24,pending:3},
        {id:102,name:'Cardio Conditioning • 10th',desc:'Heart-rate zones and pacing.',teacher:'You',students:18,pending:5},
        {id:103,name:'Flex & Mobility • 11th',desc:'Mobility drills and recovery.',teacher:'You',students:16,pending:0},
        {id:104,name:'Athletic Prep • 12th',desc:'Sport-specific conditioning.',teacher:'You',students:20,pending:1},
        {id:105,name:'Yoga Basics • 9th',desc:'Breath & posture.',teacher:'You',students:12,pending:0},
        {id:106,name:'Cross-Training • 10th',desc:'Mixed modal workouts.',teacher:'You',students:22,pending:2},
        {id:107,name:'Endurance • 11th',desc:'Distance training.',teacher:'You',students:14,pending:0},
        {id:108,name:'Plyometrics • 12th',desc:'Explosive power.',teacher:'You',students:10,pending:4}
    ];

    state.forms = [
        {id:201,title:'Weekly Reflection',prompt:'How did you feel this week?',assigned_to:102,due:'2025-11-12',pendingCount:3},
        {id:202,title:'Recovery Check',prompt:'Describe your recovery since last session.',assigned_to:101,due:'2025-11-10',pendingCount:2}
    ];

    state.submissions = [
        {id:301,formId:201,student:'Alex P.',submittedAt:'2025-11-08',text:'Felt good, slight soreness in quads.'},
        {id:302,formId:202,student:'Maria K.',submittedAt:'2025-11-07',text:'Good sleep, tight hamstrings.'}
    ];

    state.threads = [
        {id:1, title:'Emily Johnson', last:'11:23', unread:2, messages:[{from:'Emily',text:'Can we reschedule?'}]},
        {id:2, title:'Alex P.', last:'Yesterday', unread:1, messages:[{from:'Alex',text:'I missed class.'}]}
    ];
}

// --- Helpers: modal open/close ---
function openModal(id) {
    const el = document.getElementById(id);
    if (!el) return console.warn('openModal missing:', id);
    el.classList.remove('hidden');
    el.classList.add('flex');
    document.body.style.overflow = 'hidden';
}

function closeModal(id) {
    const el = document.getElementById(id);
    if (!el) return console.warn('closeModal missing:', id);
    el.classList.add('hidden');
    el.classList.remove('flex', 'block'); // remove possible display classes
    document.body.style.overflow = '';
}


// --- Classes rendering & pagination ---
function renderClasses(){
    const grid = $('#classesGrid');
    grid.innerHTML = '';
    const start = (state.currentPage-1)*state.pageSize;
    const pageItems = state.classes.slice(start, start+state.pageSize);
    for(const cls of pageItems){
        const art = document.createElement('article');
        art.className='card p-4';
        art.dataset.classId = cls.id;
        art.innerHTML = `
            <div class="flex items-start justify-between gap-3">
                <div>
                    <h4 class="text-md font-semibold accent">${cls.name}</h4>
                    <p class="muted text-sm mt-1">${cls.desc || 'No description'}</p>
                    <div class="mt-3 flex items-center gap-2">
                        <button class="btn-outline text-sm" data-action="open" data-id="${cls.id}">Open</button>
                        </div>
                </div>
                <div class="text-right">
                    <div class="muted text-xs">Students</div>
                    <div class="font-medium mt-1">${cls.students}</div>
                    <div class="mt-2">
                        <span class="pill px-2 py-1 rounded-full text-xs">${cls.pending} pending</span>
                    </div>
                </div>
            </div>
        `;
        grid.appendChild(art);
    }

    // update pagination text
    $('#classesRange').textContent = `${start+1}–${Math.min(start+state.pageSize, state.classes.length)}`;
    $('#classesTotal').textContent = state.classes.length;
    $('#currentPage').textContent = state.currentPage;
    $('#prevPage').disabled = state.currentPage===1;
    $('#nextPage').disabled = start+state.pageSize >= state.classes.length;
}

function prevPage(){ if(state.currentPage>1){ state.currentPage--; renderClasses(); }}
function nextPage(){ if((state.currentPage)*state.pageSize < state.classes.length){ state.currentPage++; renderClasses(); }}

// --- Class actions ---
function openClass(id){
    alert('Open class: '+id+' (Replace with navigation to class detail)');
}
function editClass(id){
    alert('Edit class: '+id);
}

// --- Assign form modal flow ---
function openAssignFormModal(classId=null){
    // populate class select
    const sel = $('#af_class');
    sel.innerHTML = '';
    for(const c of state.classes){
        const opt = document.createElement('option'); opt.value=c.id; opt.textContent=c.name; sel.appendChild(opt);
    }
    if(classId) sel.value = classId;
    openModal('assignFormModal');
}

async function submitAssignForm(){
    const payload = {
        classId: $('#af_class').value,
        title: $('#af_title').value.trim(),
        prompt: $('#af_prompt').value.trim(),
        due: $('#af_due').value || null
    };
    // POST to backend (placeholder)
    try{
        await fakePost('/api/forms/assign', payload);
        alert('Form assigned (mock). Refreshing list.');
        closeModal('assignFormModal');
        // update local mock
        const newId = 200 + (state.forms.length+1);
        state.forms.push({id:newId,title:payload.title,prompt:payload.prompt,assigned_to:parseInt(payload.classId),due:payload.due,pendingCount:0});
        renderActiveForms();
    }catch(e){ console.error(e); alert('Failed to assign (mock).'); }
}

// --- Add Achievement flows ---
function openAddAchievementModal(classId=null){
    if(classId){ $('#ach_student').value = '';} // classId might preselect students in future
    openModal('addAchievementModal');
}

async function submitAchievement(){
    const payload = {
        student: $('#ach_student').value.trim(),
        title: $('#ach_title').value.trim(),
        date: $('#ach_date').value || null,
        desc: $('#ach_desc').value.trim()
    };
    try{
        await fakePost('/api/achievements/add', payload);
        alert('Achievement added (mock).');
        closeModal('addAchievementModal');
    }catch(e){ console.error(e); alert('Failed to add achievement (mock).'); }
}

async function quickAddAchievement(){
    const payload = {
        student: $('#qa_student').value.trim(),
        title: $('#qa_title').value.trim(),
        date: $('#qa_date').value || null,
        desc: $('#qa_desc').value.trim()
    };
    try{
        await fakePost('/api/achievements/add', payload);
        alert('Quick achievement added (mock).');
        // clear
        $('#qa_student').value=''; $('#qa_title').value=''; $('#qa_date').value=''; $('#qa_desc').value='';
    }catch(e){ console.error(e); alert('Failed (mock).'); }
}

// --- Forms & submissions rendering ---
function renderActiveForms(){
    // update pending total
    const pendingTotal = state.forms.reduce((s,f)=> s+ (f.pendingCount||0),0);
    $('#pendingTotal').textContent = pendingTotal;
    $('#formsToGrade').textContent = pendingTotal;

    // populate forms area (main column)
    const container = document.querySelector('#pendingForms')?.parentElement?.parentElement; // not ideal; instead update cards where necessary
    // For simplicity, keep current static cards; but update the total placeholders elsewhere
}

function openSubmissions(formId){
    // list submissions for a form — for demo show an alert
    const subs = state.submissions.filter(s=> s.formId===formId);
    if(subs.length===0) return alert('No submissions for this form.');
    let list = subs.map(s=> `${s.student} — ${s.submittedAt} (id:${s.id})`).join('\n');
    alert('Submissions:\n'+list);
}

// --- Grade modal flow ---
function openGradeModal(submissionIdOrFormId){
    // find submission; allow passing formId to open a generic grade modal
    const sub = state.submissions.find(s=> s.id===submissionIdOrFormId) || state.submissions.find(s=> s.formId===submissionIdOrFormId);
    if(!sub){
        // show generic grade modal for formId
        $('#gradeStudent').textContent = '—';
        $('#gradeResponseText').textContent = 'No submission preview available.';
        openModal('gradeModal');
        return;
    }
    $('#gradeStudent').textContent = sub.student;
    $('#gradeResponseText').textContent = sub.text;
    $('#gradeModal').dataset.targetSubmission = sub.id;
    // reset grade form
    $('#gradeValue').value = '4'; $('#gradeComment').value = '';
    openModal('gradeModal');
}

async function submitGrade(){
    const submissionId = document.getElementById('gradeModal').dataset.targetSubmission;
    const payload = {submissionId, rating: $('#gradeValue').value, comment: $('#gradeComment').value.trim()};
    try{
        await fakePost('/api/submissions/grade', payload);
        alert('Grade saved (mock).');
        closeModal('gradeModal');
        // decrement pending counts in mock state
        const subIdx = state.submissions.findIndex(s=> String(s.id)===String(submissionId));
        if(subIdx>=0) state.submissions.splice(subIdx,1);
        // recompute counts
        state.forms.forEach(f=> f.pendingCount = state.submissions.filter(s=> s.formId===f.id).length);
        renderActiveForms();
    }catch(e){ console.error(e); alert('Failed to grade (mock).'); }
}

function openPendingResponses(){
    // show a simple list — in a full app you'd list and link to grade modal
    if(state.submissions.length===0) return alert('No pending responses.');
    const lines = state.submissions.map(s=> `${s.student} — ${s.submittedAt} — form ${s.formId} (id ${s.id})`).join('\n');
    alert('Pending responses:\n'+lines);
}

// --- Stats drawing (arcs) ---
function drawArc(pathEl, percent){
    // percent 0-100
    const radius = 15.91549430918954; // as in SVG
    const circumference = 2*Math.PI*radius;
    const length = (percent/100)*circumference;
    // stroke-dasharray: length, circumference
    pathEl.setAttribute('d', describeArc(18,18,15.91549430918954,0, (percent/100)*360));
}

// helper to produce SVG arc path string
function describeArc(x, y, radius, startAngle, endAngle){
    const start = polarToCartesian(x,y,radius,endAngle);
    const end = polarToCartesian(x,y,radius,startAngle);
    const largeArcFlag = endAngle - startAngle <= 180 ? '0' : '1';
    return [`M ${start.x} ${start.y}`, `A ${radius} ${radius} 0 ${largeArcFlag} 0 ${end.x} ${end.y}`].join(' ');
}
function polarToCartesian(centerX, centerY, radius, angleInDegrees){
    const angleInRadians = (angleInDegrees-90) * Math.PI / 180.0;
    return { x: centerX + (radius * Math.cos(angleInRadians)), y: centerY + (radius * Math.sin(angleInRadians)) };
}

function refreshStats(){
    // In a real app we'd fetch stats; here compute from mock
    const totalStudents = state.classes.reduce((s,c)=> s + (c.students||0),0);
    const pending = state.forms.reduce((s,f)=> s + (f.pendingCount||0),0);
    const weekly = Math.max(0, Math.round(totalStudents*0.18));
    const avgRating = 3.6; // mock

    $('#activeCount').textContent = totalStudents;
    $('#formsToGrade').textContent = pending;
    $('#weeklyParticipation').textContent = weekly;
    $('#avgRating').textContent = avgRating.toFixed(1);

    // draw arcs (arbitrary percentages for demo)
    drawArc(document.getElementById('activeArcT'), Math.min(100, (totalStudents/200)*100));
    drawArc(document.getElementById('completionArcT'), Math.min(100, (1 - pending/50)*100));
    drawArc(document.getElementById('participationArcT'), Math.min(100, (weekly/200)*100));
    drawArc(document.getElementById('teacherArcT'), Math.min(100, avgRating/4*100));

    $('#statsUpdated').textContent = new Date().toLocaleString();
}

// --- Messenger functions ---
function openThread(id){
    const thread = state.threads.find(t=> t.id==id);
    if(!thread) return;
    const chatWindow = $('#chatWindow');
    chatWindow.innerHTML = '';
    for(const m of thread.messages){
        const div = document.createElement('div'); div.className='p-2 card'; div.textContent = `${m.from}: ${m.text}`; chatWindow.appendChild(div);
    }
}

async function sendMessage(){
    const to = $('#msgTo').value || 'unknown';
    const text = $('#msgInput').value.trim();
    if(!text) return;
    try{
        await fakePost('/api/messages/send',{to,text});
        // append to chat window in UI
        const msgDiv = document.createElement('div'); msgDiv.className='p-2 card'; msgDiv.textContent = `You: ${text}`; $('#chatWindow').appendChild(msgDiv);
        $('#msgInput').value='';
    }catch(e){ console.error(e); alert('Failed to send (mock).'); }
}

// --- Search autocomplete ---
let autoTimer = null;
function initSearch(){
    const box = $('#searchBox');
    const auto = $('#autocomplete');
    const results = $('#autoResults');
    box.addEventListener('input', (e)=>{
        const q = e.target.value.trim();
        if(autoTimer) clearTimeout(autoTimer);
        autoTimer = setTimeout(()=> performSearch(q), 220);
    });
    box.addEventListener('focus', ()=>{ if(box.value.trim()) auto.classList.remove('hidden'); });
    box.addEventListener('keydown', (ev)=>{
        if(ev.key==='Enter'){
            ev.preventDefault();
            const q = box.value.trim(); if(!q) return;
            // simulate go to first result or search page
            const match = findPersonByName(q);
            if(match) alert('Go to profile: '+match);
            else alert('No match. Would perform search for: '+q);
            auto.classList.add('hidden');
        }
    });

    function performSearch(q){
        if(!q){ auto.classList.add('hidden'); return; }
        // mock: search in classes and threads and students
        const matches = [];
        // students from submissions
        for(const s of state.submissions){ if(s.student.toLowerCase().includes(q.toLowerCase())) matches.push({type:'student',name:s.student}); }
        for(const c of state.classes){ if(c.name.toLowerCase().includes(q.toLowerCase())) matches.push({type:'class',name:c.name}); }
        for(const t of state.threads){ if(t.title.toLowerCase().includes(q.toLowerCase())) matches.push({type:'teacher',name:t.title}); }

        results.innerHTML = '';
        if(matches.length===0){ results.innerHTML = '<div class="p-2 small muted">No matches</div>'; }
        for(const m of matches.slice(0,8)){
            const btn = document.createElement('button'); btn.className='w-full text-left p-2 hover:bg-gray-50 rounded';
            btn.textContent = `${m.type.toUpperCase()} • ${m.name}`;
            btn.addEventListener('click', ()=>{ $('#searchBox').value = m.name; $('#autocomplete').classList.add('hidden'); alert('Navigate to '+m.type+': '+m.name); });
            results.appendChild(btn);
        }
        auto.classList.remove('hidden');
    }
}

function findPersonByName(q){
    const s = state.submissions.find(s=> s.student.toLowerCase()===q.toLowerCase());
    if(s) return s.student;
    const t = state.threads.find(t=> t.title.toLowerCase()===q.toLowerCase()); if(t) return t.title;
    return null;
}

// --- Filters aside (open/close) ---
function initFilters(){
    $('#openFiltersAside').addEventListener('click', ()=>{
        // open left filter panel (simple implementation)
        let panel = document.querySelector('.filter-panel');
        if(!panel){
            panel = document.createElement('aside'); panel.className='filter-panel card p-6'; panel.innerHTML = `<div class="flex items-center justify-between"><h3 class="font-semibold">Filters</h3><button class="btn-outline" id="closeFiltersBtn">Close</button></div><div class="mt-4 small muted">Filter UI goes here</div>`; document.body.appendChild(panel);
            $('#closeFiltersBtn').addEventListener('click', ()=>{ panel.style.transform='translateX(-100%)'; setTimeout(()=> panel.remove(),300); });
            // animate in
            panel.style.transition='transform .28s ease'; requestAnimationFrame(()=> panel.style.transform='translateX(0)');
        }
    });
}

// --- Modal helper bindings for elements that call openModal/closeModal by name ---
function bindGlobalActions(){
    document.body.addEventListener('click', (ev)=>{
        const btn = ev.target.closest('[data-action]');
        if(btn){
            const action = btn.dataset.action;
            const id = btn.dataset.id;
            if(action==='open') openClass(id);
            if(action==='assign') openAssignFormModal(parseInt(id));
            if(action==='achieve') openAddAchievementModal(parseInt(id));
        }
    });

    $('#prevPage').addEventListener('click', prevPage);
    $('#nextPage').addEventListener('click', nextPage);

    // wire modal forms
    $('#assignForm').addEventListener('submit', submitAssignForm);
    $('#addAchievementForm').addEventListener('submit', submitAchievement);
    document.getElementById('gradeForm').addEventListener('submit', submitGrade);
    $('#addStatsForm').addEventListener('submit', submitStats);
    $('#quickAchievementForm').addEventListener('submit', (e)=>{ e.preventDefault(); quickAddAchievement(); });

    // messenger
    $('#openMessagesBtn').addEventListener('click', ()=> openModal('messengerModal'));
    // populate thread list
    renderThreads();
}

function renderThreads(){
    const list = $('#threadList'); list.innerHTML='';
    for(const t of state.threads){
        const btn = document.createElement('button'); btn.className='p-3 card w-full text-left thread-item'; btn.dataset.threadId = t.id; btn.addEventListener('click', ()=> openThread(t.id));
        btn.innerHTML = `<div class="flex items-center justify-between"><div><div class="font-medium">${t.title}</div><div class="small muted">${t.unread? t.unread+' new':''}</div></div><div class="small muted">${t.last}</div></div>`;
        list.appendChild(btn);
    }
}

// --- Add / Update Stats ---
function openAddStatsModal(){ openModal('addStatsModal'); }
async function submitStats(){
    const payload = { student: $('#stat_student').value.trim(), metric: $('#stat_metric').value.trim(), value: $('#stat_value').value.trim(), date: $('#stat_date').value || null };
    try{ await fakePost('/api/stats/add', payload); alert('Stat saved (mock).'); closeModal('addStatsModal'); }catch(e){ console.error(e); alert('Failed (mock).'); }
}

// --- Fake POST helper to simulate network latency ---
function fakePost(url, data){
    console.log('POST',url,data);
    return new Promise((res,rej)=> setTimeout(()=> res({ok:true}), 400));
}

// --- Initialize on DOM ready ---
document.addEventListener('DOMContentLoaded', ()=>{
    seedMockData();
    renderClasses();
    renderActiveForms();
    refreshStats();
    initSearch();
    initFilters();
    bindGlobalActions();

    // wire other UI bits
    $('#refreshStats').addEventListener('click', refreshStats);
    // attach handlers for assign/add from right column
    document.querySelectorAll('[onclick^="openAssignFormModal"]').forEach(btn=>{
        // no-op; already handled by data-action in render
    });

    // provide global helpers to window so HTML inline handlers can call them
    window.openClass = openClass;
    window.editClass = editClass;
    window.openAssignFormModal = openAssignFormModal;
    window.openAddAchievementModal = openAddAchievementModal;
    window.openSubmissions = openSubmissions;
    window.openGradeModal = openGradeModal;
    window.openPendingResponses = openPendingResponses;
    window.openAddStatsModal = openAddStatsModal;
    window.openModal = openModal;
    window.closeModal = closeModal;
});
